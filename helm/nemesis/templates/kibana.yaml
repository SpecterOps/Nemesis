---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kibana
  labels:
    app: kibana
data:
  saved-objects.ndjson: |
    {"attributes":{"fieldAttrs":"{\"kubernetes.container_name\":{\"count\":1},\"kubernetes.labels.app\":{\"count\":2},\"kubernetes.pod_ip\":{\"count\":1},\"kubernetes.pod_name\":{\"count\":3},\"log\":{\"count\":2},\"tag\":{\"count\":1},\"kubernetes.labels.component\":{\"count\":1}}","fields":"[]","runtimeFieldMap":"{}","timeFieldName":"@timestamp","title":"fluentd-*","typeMeta":"{}"},"coreMigrationVersion":"8.3.3","id":"50ee9180-7ccf-11ed-b4d6-697552d297be","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"sort":[1671304759231,545],"type":"index-pattern","updated_at":"2022-12-17T19:19:19.231Z","version":"WzUwMiwxXQ=="}
    {"attributes":{"fieldAttrs":"{}","fields":"[]","runtimeFieldMap":"{}","timeFieldName":"metadata.timestamp","title":"service_enriched","typeMeta":"{}"},"coreMigrationVersion":"8.3.3","id":"5ef6715c-a035-4bc7-a8fc-724e1963c19f","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"type":"index-pattern","updated_at":"2023-03-21T04:42:54.962Z","version":"Wzk2LDFd"}
    {"attributes":{"fieldAttrs":"{}","fields":"[]","runtimeFieldMap":"{}","timeFieldName":"metadata.timestamp","title":"authentication_data","typeMeta":"{}"},"coreMigrationVersion":"8.3.3","id":"dbf88f6c-1d07-41f7-80e7-8998b7195637","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"type":"index-pattern","updated_at":"2023-03-21T04:42:54.962Z","version":"Wzk2LDFd"}
    {"attributes":{"fieldAttrs":"{}","fields":"[]","runtimeFieldMap":"{}","timeFieldName":"metadata.timestamp","title":"extracted_hash","typeMeta":"{}"},"coreMigrationVersion":"8.3.3","id":"d884e1d0-c7a2-11ed-99da-e7509f36608c","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"type":"index-pattern","updated_at":"2023-03-21T04:42:54.962Z","version":"Wzk2LDFd"}
    {"attributes":{"fieldAttrs":"{\"metadata.originating_object_id\":{\"count\":1},\"metadata.originating_object_path\":{\"count\":1},\"metadata.plaintext_object_id\":{\"count\":1},\"text\":{\"count\":1}}","fieldFormatMap":"{}","fields":"[]","name":"text_embeddings","runtimeFieldMap":"{}","sourceFilters":"[]","title":"text_embeddings","typeMeta":"{}"},"coreMigrationVersion":"8.8.0","created_at":"2024-03-06T07:09:57.528Z","id":"45fbaacb-9ef9-4cd1-b837-bc8ab0448220","managed":false,"references":[],"type":"index-pattern","typeMigrationVersion":"8.0.0","updated_at":"2024-03-06T07:14:57.092Z","version":"WzQ4LDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"Logs from all pods with filters attempting to exclude common endpoints hit for health/metrics","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"NOT log:\\\"GET /ready\\\" AND NOT log:\\\"\\\\\\\"uri\\\\\\\":\\\\\\\"/prometheus/metrics\\\\\\\",\\\\\\\"method\\\\\\\":\\\\\\\"GET\\\\\\\"\\\" AND NOT log:\\\"GET /metrics\\\"\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - All Pods"},"coreMigrationVersion":"8.3.3","id":"00def580-7cda-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1671304274669,44],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzMyLDFd"}
    {"attributes":{"allowNoIndex":true,"fieldAttrs":"{}","fieldFormatMap":"{\"objectIdURL\":{\"id\":\"url\"},\"originatingObjectURL\":{\"id\":\"url\"}}","fields":"[]","runtimeFieldMap":"{}","timeFieldName":"metadata.timestamp","title":"file_data_plaintext","typeMeta":"{}"},"coreMigrationVersion":"8.3.3","id":"0e93c4fb-c291-4d22-84da-e49ec27b959a","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"sort":[1671304274669,64],"type":"index-pattern","updated_at":"2022-12-17T19:11:14.669Z","version":"WzQyLDFd"}
    {"attributes":{"allowNoIndex":true,"fieldAttrs":"{}","fieldFormatMap":"{\"fileObjectURL\":{\"id\":\"url\"},\"downloadURL\":{\"id\":\"url\"}}","fields":"[]","runtimeFieldMap":"{}","timeFieldName":"metadata.timestamp","title":"file_data_sourcecode","typeMeta":"{}"},"coreMigrationVersion":"8.3.3","id":"22aa12e1-deab-4f35-a413-5340bb141683","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"sort":[1671304274669,64],"type":"index-pattern","updated_at":"2022-12-17T19:11:14.669Z","version":"WzQyLDFd"}
    {"attributes":{"columns":["kubernetes.pod_ip","kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"file-processor\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"file-processor\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - file-processor"},"coreMigrationVersion":"8.3.3","id":"12695c50-7cd0-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,15],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzIyLDFd"}
    {"attributes":{"allowNoIndex":true,"fieldAttrs":"{}","fieldFormatMap":"{\"convertedPdfURL\":{\"id\":\"url\"},\"objectIdURL\":{\"id\":\"url\"},\"extractedPlaintextURL\":{\"id\":\"url\"},\"extractedSourceURL\":{\"id\":\"url\"}}","fields":"[]","runtimeFieldMap":"{}","timeFieldName":"metadata.timestamp","title":"file_data_enriched","typeMeta":"{}"},"coreMigrationVersion":"8.3.3","id":"26360ae8-a518-4dac-b499-ef682d3f6bac","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"sort":[1671304274669,54],"type":"index-pattern","updated_at":"2022-12-17T19:11:14.669Z","version":"WzM3LDFd"}
    {"attributes":{"columns":["path","analysis.dotnetAnalysis.hasCmdExecution","analysis.dotnetAnalysis.hasDeserialization","objectIdURL","extractedSourceURL"],"description":"Searches for .NET files with deserialization or CMD execution.","grid":{"columns":{"analysis.dotnetAnalysis.hasCmdExecution":{"width":280.25},"magicType":{"width":287},"metadata.timestamp":{"width":213},"path":{"width":231}}},"hideChart":true,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"analysis.dotnetAnalysis.hasDeserialization:true or analysis.dotnetAnalysis.hasCmdExecution:true\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[],"title":"Analysis - .NET Binary Targets for Vuln Research"},"coreMigrationVersion":"8.3.3","id":"41265860-69e6-11ed-b7f1-a33c99d56089","migrationVersion":{"search":"8.0.0"},"references":[{"id":"26360ae8-a518-4dac-b499-ef682d3f6bac","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1671304274669,56],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzM4LDFd"}
    {"attributes":{"columns":["path","magicType","convertedPdfURL","objectIdURL"],"description":"A view that shows the links for office documents converted to PDFs.","grid":{"columns":{"magicType":{"width":227},"path":{"width":330.6666666666667}}},"hideChart":true,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"convertedPdfURL :*\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"exists\",\"key\":\"convertedPdfURL\",\"value\":\"exists\",\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"exists\":{\"field\":\"convertedPdfURL\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[],"title":"Analysis - Office Documents Converted to PDF"},"coreMigrationVersion":"8.3.3","id":"47f16280-3b69-11ed-9953-951df4a607ed","migrationVersion":{"search":"8.0.0"},"references":[{"id":"26360ae8-a518-4dac-b499-ef682d3f6bac","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"26360ae8-a518-4dac-b499-ef682d3f6bac","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,59],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzM5LDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"process-categorizer\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"process-categorizer\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - process-categorizer"},"coreMigrationVersion":"8.3.3","id":"496322c0-7cd7-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,30],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzI3LDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"Service that extracts information from .NET binaries","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"NOT log:\\\"GET /ready\\\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"dotnet\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"dotnet\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - dotnet"},"coreMigrationVersion":"8.3.3","id":"5d84b590-7cd5-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,47],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzMzLDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"elastalert2\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"elastalert2\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - elastalert"},"coreMigrationVersion":"8.3.3","id":"639dcea0-7cd8-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,24],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzI1LDFd"}
    {"attributes":{"allowNoIndex":true,"fieldAttrs":"{}","fieldFormatMap":"{\"objectIdURL\":{\"id\":\"url\"},\"originatingObjectURL\":{\"id\":\"url\"}}","fields":"[]","runtimeFieldMap":"{}","timeFieldName":"metadata.timestamp","title":"process_category","typeMeta":"{}"},"coreMigrationVersion":"8.3.3","id":"a005f4d8-3b6a-401d-b489-643ee0cc14f6","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"sort":[1671304274669,51],"type":"index-pattern","updated_at":"2022-12-17T19:11:14.669Z","version":"WzM1LDFd"}
    {"attributes":{"columns":["metadata.agentId","processId","name","category.description"],"description":"Search for security process listings.","grid":{"columns":{"magicType":{"width":287},"metadata.agentId":{"width":156.25},"metadata.timestamp":{"width":213},"path":{"width":512},"processId":{"width":126.25}}},"hideChart":true,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"category.category : \\\"Security\\\"\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["metadata.timestamp","desc"]],"title":"Analysis - Security Processes"},"coreMigrationVersion":"8.3.3","id":"65b1ac50-3b62-11ed-9953-951df4a607ed","migrationVersion":{"search":"8.0.0"},"references":[{"id":"a005f4d8-3b6a-401d-b489-643ee0cc14f6","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1671304274669,53],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzM2LDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"NOT log:\\\"GET /ready\\\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"ml-models\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"ml-models\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - ml-models"},"coreMigrationVersion":"8.3.3","id":"7aa0f300-7cd5-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,39],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzMwLDFd"}
    {"attributes":{"buildNum":53682,"defaultIndex":"0e93c4fb-c291-4d22-84da-e49ec27b959a","discover:rowHeightOption":-1,"history:limit":20,"isDefaultIndexMigrated":true,"savedObjects:perPage":50,"theme:darkMode":null,"timepicker:timeDefaults":"{\n  \"from\": \"now-60m\",\n  \"to\": \"now\"\n}"},"coreMigrationVersion":"8.3.3","id":"8.3.3","migrationVersion":{"config":"8.1.0"},"references":[],"sort":[1671304274669,11],"type":"config","updated_at":"2022-12-17T19:11:14.669Z","version":"WzIwLDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"tensorflow-serving\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"tensorflow-serving\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - tensorflow-serving"},"coreMigrationVersion":"8.3.3","id":"824b4fe0-7cd7-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,33],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzI4LDFd"}
    {"attributes":{"columns":["kubernetes.pod_ip","kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"NOT log:\\\"*/prometheus/metrics*\\\" AND NOT log:\\\"*uri\\\\\\\":\\\\\\\"*\\\\/health*\\\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"gotenberg\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"gotenberg\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - Gotenberg"},"coreMigrationVersion":"8.3.3","id":"8bf00c40-7cd0-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,18],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzIzLDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"elastalert2\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"elastalert2\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - elasticsearch-exporter"},"coreMigrationVersion":"8.3.3","id":"963b1cf0-7cd8-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,27],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzI2LDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"Service that extracts text from documents.","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"tika\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"tika\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - tika"},"coreMigrationVersion":"8.3.3","id":"9b328870-7cd2-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,50],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzM0LDFd"}
    {"attributes":{"columns":["path","magicType","objectIdURL"],"description":"Search for downloaded files that have DPAPI blobs within them.","grid":{"columns":{"magicType":{"width":287},"metadata.timestamp":{"width":213},"path":{"width":512}}},"hideChart":true,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"containsDpapi : true \",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[],"title":"Analysis - Files containing DPAPI-encrypted blobs"},"coreMigrationVersion":"8.3.3","id":"b9e9d7d0-3b61-11ed-9953-951df4a607ed","migrationVersion":{"search":"8.0.0"},"references":[{"id":"26360ae8-a518-4dac-b499-ef682d3f6bac","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1671304274669,63],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzQxLDFd"}
    {"attributes":{"columns":["path","magicType","nemesisFileType","objectIdURL"],"description":"Searches for files that have parsed credentials.","grid":{"columns":{"magicType":{"width":287},"metadata.agentId":{"width":121.25},"metadata.timestamp":{"width":213},"nemesisFileType":{"width":191.375},"path":{"width":306},"processId":{"width":126.25}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"parsedData.hasParsedCredentials : true \",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[],"title":"Analysis - Files with Parsed Credentials"},"coreMigrationVersion":"8.3.3","id":"d209edd0-3b72-11ed-9953-951df4a607ed","migrationVersion":{"search":"8.0.0"},"references":[{"id":"26360ae8-a518-4dac-b499-ef682d3f6bac","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"sort":[1671304274669,61],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzQwLDFd"}
    {"attributes":{"columns":["metadata.timestamp","path","noseyparker.ruleMatches.ruleName","noseyparker.ruleMatches.matches.snippet.matching","objectIdURL"],"description":"Searches for files that have NoseyParker results.","grid":{"columns":{"magicType":{"width":287},"metadata.agentId":{"width":121.25},"metadata.timestamp":{"width":213},"nemesisFileType":{"width":191.375},"path":{"width":306},"processId":{"width":126.25}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"noseyparker.ruleMatches.ruleName: *\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["metadata.timestamp","desc"]],"title":"Analysis - Files with NoseyParker Results"},"coreMigrationVersion":"8.3.3","id":"12fc0ad0-91d6-11ed-ac72-710978b7b4f1","migrationVersion":{"search":"8.0.0"},"references":[{"id":"26360ae8-a518-4dac-b499-ef682d3f6bac","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"type":"search","updated_at":"2023-01-11T17:33:34.609Z","version":"WzE4NywxXQ=="}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"Logs for the es-connector, which is a python app that consume events and adds them into the appropriate Elastic index","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"es-connector\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"es-connector\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - es-connector"},"coreMigrationVersion":"8.3.3","id":"e2d110a0-7ccf-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,42],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzMxLDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"Logs for the dpapi, which is a python app that consume events and adds them into the appropriate Elastic index","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"dpapi\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"dpapi\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - dpapi"},"coreMigrationVersion":"8.3.3","id":"ed76c3ee-40ce-4595-9179-94921835661a","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,42],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzMxLDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"Logs for the pg-connector, which is a python app that consume events and adds them into the appropriate Postgres table","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"pg-connector\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"pg-connector\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - pg-connector"},"coreMigrationVersion":"8.3.3","id":"a5806f41-add2-4f58-bf7b-c0e64b23a773","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,42],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzMxLDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"Logs from all enrichment service pods with filters attempting to exclude common endpoints hit for health/metrics","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.component\",\"params\":{\"query\":\"enrichment-pipeline\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.component\":\"enrichment-pipeline\"}},\"$state\":{\"store\":\"appState\"}},{\"meta\":{\"alias\":null,\"negate\":true,\"disabled\":false,\"type\":\"phrase\",\"key\":\"log\",\"params\":{\"query\":\"GET /metrics\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[1].meta.index\"},\"query\":{\"match_phrase\":{\"log\":\"GET /metrics\"}},\"$state\":{\"store\":\"appState\"}},{\"meta\":{\"alias\":null,\"negate\":true,\"disabled\":false,\"type\":\"phrase\",\"key\":\"log\",\"params\":{\"query\":\"log:\\\"\\\\\\\"uri\\\\\\\":\\\\\\\"/prometheus/metrics\\\\\\\",\\\\\\\"method\\\\\\\":\\\\\\\"GET\\\\\\\"\\\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[2].meta.index\"},\"query\":{\"match_phrase\":{\"log\":\"log:\\\"\\\\\\\"uri\\\\\\\":\\\\\\\"/prometheus/metrics\\\\\\\",\\\\\\\"method\\\\\\\":\\\\\\\"GET\\\\\\\"\\\"\"}},\"$state\":{\"store\":\"appState\"}},{\"meta\":{\"alias\":null,\"negate\":true,\"disabled\":false,\"type\":\"phrase\",\"key\":\"log\",\"params\":{\"query\":\"GET /ready\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[3].meta.index\"},\"query\":{\"match_phrase\":{\"log\":\"GET /ready\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - All Enrichment Services"},"coreMigrationVersion":"8.3.3","id":"e4c48570-7e3e-11ed-9f54-2def5956b9b7","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[1].meta.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[2].meta.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[3].meta.index","type":"index-pattern"}],"sort":[1671304780900,619],"type":"search","updated_at":"2022-12-17T19:19:40.900Z","version":"WzU4MCwxXQ=="}
    {"attributes":{"columns":["kubernetes.pod_ip","kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"NOT log:\\\"GET /ready\\\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"generate-crack-list\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"generate-crack-list\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - generate-crack-list"},"coreMigrationVersion":"8.3.3","id":"fb1c60e0-7cd6-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,21],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzI0LDFd"}
    {"attributes":{"columns":["kubernetes.pod_name","log"],"description":"","grid":{"columns":{"kubernetes.container_name":{"width":208},"kubernetes.labels.app":{"width":398.6666666666667},"kubernetes.pod_ip":{"width":129.66666666666663},"kubernetes.pod_name":{"width":206.66666666666669}}},"hideChart":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"NOT log:\\\"GET /metrics\\\"\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"kubernetes.labels.app\",\"params\":{\"query\":\"web-api\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"match_phrase\":{\"kubernetes.labels.app\":\"web-api\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"title":"Logs - web-api (Nemesis Web API)"},"coreMigrationVersion":"8.3.3","id":"fc99d5f0-7cd2-11ed-b4d6-697552d297be","migrationVersion":{"search":"8.0.0"},"references":[{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"50ee9180-7ccf-11ed-b4d6-697552d297be","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"sort":[1671304274669,36],"type":"search","updated_at":"2022-12-17T19:11:14.669Z","version":"WzI5LDFd"}
---
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: nemesis
spec:
  version: 8.8.0
  count: 1
  elasticsearchRef:
    name: nemesis
  config:
    telemetry.enabled: false
    telemetry.optIn: false
    newsfeed.enabled: false
    xpack.security.authc.providers:
      basic.basci1:
        order: 1
      anonymous.anonymous1:
        order: 0
        description: "Log into Kibana"
        credentials: "elasticsearch_anonymous_user"
  http:
    tls:
      selfSignedCertificate:
        disabled: true
  podTemplate:
    spec:
      containers:
      - name: kibana
        imagePullPolicy: IfNotPresent
        env:
        # - name: "SERVER_REWRITEBASEPATH"
        #   value: "true"
        - name: ELASTIC_URL
          value: http://nemesis-es-http.default.svc.cluster.local:9200
        - name: KIBANA_URL
          value: http://nemesis-kb-http.default.svc.cluster.local:5601
        - name: NEMESIS_HTTP_SERVER
          valueFrom:
            configMapKeyRef:
              name: operation-config
              key: nemesis-http-server
        - name: SERVER_BASEPATH
          value: "/kibana"
        - name: SERVER_PUBLICBASEURL
          value: "$(NEMESIS_HTTP_SERVER)kibana"
        - name: ELASTICSEARCH_USER
          valueFrom:
            secretKeyRef:
              name: {{ .Values.elasticsearch.existingSecret }}
              key: username
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.elasticsearch.existingSecret }}
              key: password
        # readinessProbe:
        #   failureThreshold: 3
        #   httpGet:
        #     path: /kibana/status
        #     port: 5601
        #     scheme: HTTP
        #   initialDelaySeconds: 10
        #   periodSeconds: 10
        #   successThreshold: 1
        #   timeoutSeconds: 5
---
# Reference: https://github.com/sjbavier/Reference/blob/2b19339f007a82c180d73b7edb662bfe5b6fb9ee/google-cloud/examples/click-to-deploy/k8s/elastic-gke-logging/chart/elastic-gke-logging/templates/kibana-manifests.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: kibana-init-job
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      initContainers:
        - name: kibana-waiter
          image: "{{ .Values.nemesisWaiter.image.repository }}:{{ .Values.nemesisWaiter.image.tag }}"
          imagePullPolicy: {{ .Values.nemesisWaiter.image.pullPolicy }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Waiting for Kibana..."

              COUNTER=1
              URL="${KIBANA_URL}/api/status"
              until curl --silent --user "${ELASTICSEARCH_USER}:${ELASTICSEARCH_PASSWORD}" --insecure --max-time 5 \
                $URL \
                | jq '.status.overall.level' \
                | grep "available" > /dev/null; do
                echo "Retry ${COUNTER}: Waiting for Kibana at ${URL}..."
                COUNTER=`expr ${COUNTER} + 1`
                sleep 5
              done

              echo "Kibana available."
          env:
            - name: ELASTICSEARCH_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.elasticsearch.existingSecret }}
                  key: username
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.elasticsearch.existingSecret }}
                  key: password
            - name: KIBANA_URL
              value: http://nemesis-kb-http.default.svc.cluster.local:5601
      containers:
        - name: kibana-init
          image: "{{ .Values.nemesisWaiter.image.repository }}:{{ .Values.nemesisWaiter.image.tag }}"
          imagePullPolicy: {{ .Values.nemesisWaiter.image.pullPolicy }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              curl "${KIBANA_URL}/api/saved_objects/_import?overwrite=true" \
                  --form file=@/etc/kibana-config/saved-objects.ndjson \
                  --insecure \
                  --silent \
                  --fail \
                  --show-error \
                  -H "kbn-xsrf: true" \
                  -o /dev/null \
                  --user "${ELASTICSEARCH_USER}:${ELASTICSEARCH_PASSWORD}"

              curl -X PUT "${ELASTIC_URL}/file_data_plaintext" -H "Content-Type: application/json" -d'
                  {
                    "settings": {
                      "index" : {
                        "highlight.max_analyzed_offset" : 10000000
                      }
                    }
                  }
                  '

              curl -X PUT "${ELASTIC_URL}/_cluster/settings" -H "Content-Type: application/json" -d'
                  {
                    "persistent": {
                      "search.max_async_search_response_size": "50mb"
                    }
                  }
                  '

              # create a purge policy for use with fluend-* indexes
              curl -X PUT "${ELASTIC_URL}/_ilm/policy/fluentd_purge" -H "Content-Type: application/json" -d'
                  {
                    "policy": {
                      "phases": {
                        "delete": {
                          "min_age": "{{ .Values.elasticsearch.fluentdLogsAge }}d",
                          "actions": {
                            "delete": {}
                          }
                        }
                      }
                    }
                  }
                  '

              # create an index template linking the fluentd_purge policy to "fluentd-*" indexes
              curl -X PUT "${ELASTIC_URL}/_index_template/fluentd_purge" -H "Content-Type: application/json" -d'
                  {
                    "index_patterns": ["fluentd-*"],
                    "template": {
                      "settings": {
                        "index.lifecycle.name": "fluentd_purge"
                      }
                    }
                  }
                  '

          volumeMounts:
            - name: config
              mountPath: /etc/kibana-config
          env:
            - name: ELASTIC_URL
              value: http://nemesis-es-http.default.svc.cluster.local:9200
            - name: KIBANA_URL
              value: http://nemesis-kb-http.default.svc.cluster.local:5601
            - name: ELASTICSEARCH_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.elasticsearch.existingSecret }}
                  key: username
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.elasticsearch.existingSecret }}
                  key: password
      restartPolicy: Never
      volumes:
        - name: config
          configMap:
            name: kibana
  backoffLimit: 1
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: kibana-stripprefix
spec:
  stripPrefix:
    prefixes:
      - /kibana
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kibana-ingress
  annotations:
    traefik.ingress.kubernetes.io/router.middlewares: "{{ .Release.Namespace }}-kibana-stripprefix@kubernetescrd, {{ .Release.Namespace }}-{{ .Values.basicAuth.middlewareName }}@kubernetescrd"
    {{- if .Values.kibana.ingress.annotations }}
    {{- .Values.kibana.ingress.annotations | toYaml | nindent 4 }}
    {{- end }}
spec:
  ingressClassName: traefik
  rules:
    - http:
        paths:
          - path: /kibana
            pathType: Prefix
            backend:
              service:
                name: nemesis-kb-http
                port:
                  number: 5601